{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}

  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb breadcrumb-sm mb-0">
      <li class="breadcrumb-item">Project Monitoring System</li>
      <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
      </ol>
    </nav>
</div>

  <div class="alert alert-success" role="alert">
  Welcome to Dashboard! Kindly check table for status updates.
</div>

<table id="poTable" class="hover" style="width:100%">
  <thead>
    <tr>
      <th>Actions</th>
      <th>Purchase Order #</th>
      <th>Date Prepared (Email) </th>
      <th>Date Started</th>
      <th>Target Date</th>
      <th>Completion Date</th>
      <th>Status</th>
      <th></th> <!-- Hidden ID -->
    </tr>
    <tr class="filter-row">
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for po in purchase_orders %}
    <tr>
      <td>Click Details</td>
      <td>{{ po.purchase_order }}</td>
      <td>{{ po.date_recorded }}</td>
      <td>{{ po.date_started }}</td>
      <td>{{ po.target_date }}</td>
      <td>{{ po.completion_date }}</td>
      <td>
          {% if po.status == "Pending" %}
            <button class="btn btn-warning btn-sm status-btn">Pending</button>
          {% elif po.status == "Ongoing" %}
            <button class="btn btn-primary btn-sm status-btn">Ongoing</button>
          {% elif po.status == "Completed" %}
            <button class="btn btn-success btn-sm status-btn">Completed</button>
          {% else %}
            <button class="btn btn-danger btn-sm status-btn">Delayed</button>
          {% endif %}
      </td>
      <td>{{ po.id }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>


<script>
  document.addEventListener('DOMContentLoaded', function () {
  const table = new DataTable('#poTable', {
    ordering: false,
    searching: true,
    columnDefs: [
      { targets: 7, visible: false, searchable: false } // hide ID column
    ],
    language: {
      search: 'Enter: P.O #', // leave empty so we can use our own label
      searchPlaceholder: 'Type and Enter No.' // <- placeholder
    },

    search: {
      return: true // allow full control over custom global search
    },
    initComplete: function () {
      const api = this.api();

      // Restrict global search to only the first column
      $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
        const searchValue = api.search().toLowerCase();
        const poNumber = data[1].toLowerCase(); // column 0 = PO number

        // If search is empty or PO matches, keep the row
        return searchValue === "" || poNumber.includes(searchValue);
      });

      // Redraw when the global search input changes
      document.querySelector('input[type="search"]').addEventListener('input', function () {
        api.draw();
      });

      // Setup dropdown filters (same as before)
      api.columns().every(function () {
        const column = this;
        const index = column.index();
       if (index === 7 || index === 0) return; // skip index 0 and 7

        const headerCell = document.querySelector(
          `#poTable thead tr.filter-row th:nth-child(${index + 1})`
        );

        const select = document.createElement('select');
        select.innerHTML = `<option value="">Select Filter (Default All)</option>`;
        headerCell.innerHTML = '';
        headerCell.appendChild(select);

        const uniqueValues = new Set();
        column.nodes().each(function (cell) {
          const value = cell.textContent.trim();
          if (value) uniqueValues.add(value);
        });

        [...uniqueValues].sort().forEach(function (value) {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          select.appendChild(option);
        });

        select.addEventListener('change', function () {
          const val = this.value;
          column.search(val !== '' ? `^${val}$` : '', true, false).draw();
        });
      });
    }
  });
});


</script>


{% endblock %}
