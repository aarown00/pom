{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'css/stats.css' %}">
{% endblock %}

{% block content %}

{% include "toast_messages.html" %}

  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div class="d-flex align-items-center gap-2">
      {% comment %} <img src="{% static 'img/mlogo.png' %}" alt="Logo" style="height: 32px; width: 32px; object-fit: contain; margin-right: 0.5rem;"> {% endcomment %}
      <h1 class="h3 mb-0">Mabuhay Power & Diesel Generator Services Co. Ltd</h1>
    </div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb breadcrumb-sm mb-0">
      <li class="breadcrumb-item">P.O Monitoring System</li>
      <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
      </ol>
    </nav>
  </div>

  {% comment %} <div class="alert alert-success alert-dismissible fade show" role="alert">
  Welcome to Dashboard! Kindly check and manage table for status updates.
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div>

<div class="alert alert-primary alert-dismissible fade show" role="alert">
  Note: A blue Target Date indicates it has been adjusted.
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div> {% endcomment %}

  {% include "tabs.html" %}

</br>

    {% include "stats.html" %} 

</br>

  {% include "dashboard_filter.html" %} 


<div id="customScrollWrapper" style="overflow-x: auto; width: 100%;">
  <table id="poTable" class="row-border hover" style="width: 100%;">
  <thead>
    <tr>
      <th>P.O #</th>
      <th>CUSTOMER</th>
      <th>BRANCH</th>
      <th>AMOUNT</th>
      <th>STARTED DATE</th>
      <th>TARGET DATE</th>
      <th>STATUS</th>
      <th>ACTIONS</th>
      <th></th> <!-- Hidden ID -->
    </tr>   

  </thead>
  <tbody>
    {% for po in page_obj %}

    <tr>
      <td>
          <strong>{{ po.purchase_order }}</strong>
      </td>

      <td>{{ po.customer_branch.customer_name }}</td>
      <td>{{ po.customer_branch.branch_name }}</td> 
      <td>â‚±{{ po.amount|floatformat:2|intcomma }}</td>     
      <td>
        {% if po.date_started %}
          {{ po.date_started|date:"n/j/y" }}
        {% else %}
          ---
        {% endif %}
      </td>


      <td>
       {% if po.target_date_status == "adjusted" %}
        <span class="text-primary">{{ po.target_date|date:"n/j/y" }}</span>
   
      {% else %}
        {{ po.target_date|date:"n/j/y" }}
      {% endif %}
      </td>


      <td>
        {% if po.status == "Pending" %}
          <span class="status pending">Pending</span>
        {% elif po.status == "Ongoing" %}
          <span class="status ongoing">Ongoing</span>
        {% elif po.status == "Completed" %}
          <span class="status completed">Completed</span>
        {% elif po.status == "Cancelled" %}
          <span class="status cancelled">Cancelled</span>
        {% else %}
          <span class="status delayed">Delayed</span>
        {% endif %}
      </td>

       <td>
          <div class="dropdown">
            <button class="btn btn-light shadow-sm d-flex align-items-center gap-2 px-3 py-2 rounded"
                  type="button" id="dropdownMenu{{ po.id }}"
                  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
             <i data-feather="chevron-down"></i>
          </button>
             <div class="dropdown-menu dropdown-modern shadow rounded" aria-labelledby="dropdownMenu{{ po.id }}">
              <a class="dropdown-item" href="{% url 'view' username=request.user.username pk=po.id %}"><i data-feather="eye" class="mr-2"></i> View P.O</a>
              <a class="dropdown-item" href="{% url 'itinenary_details' username=request.user.username pk=po.id %}"><i data-feather="eye" class="mr-2"></i> View Itinerary</a>
              
              {% if po.status != "Cancelled" %}

              <!-- Update -->
              <a class="dropdown-item" href="{% url 'edit' username=request.user.username pk=po.id %}"><i data-feather="edit-3" class="mr-2"></i> Update P.O</a>
              <a class="dropdown-item" href="{% url 'itinenary' username=request.user.username pk=po.id %}"><i data-feather="map" class="mr-2"></i>Update Itinerary</a>

              <!-- Cancel -->
              <form method="post" action="{% url 'cancel' username=request.user.username pk=po.pk %}"
                    onsubmit="return confirmDelete('Are you sure you want to cancel this Purchase Order?\n\nP.O: {{ po.purchase_order }}\n\nWarning: This action is irreversible and cannot be undone.');">
                {% csrf_token %}
                <input type="hidden" name="status" value="Cancelled">
                <button type="submit" class="dropdown-item text-danger" style="cursor: pointer;"><i data-feather="x-circle" class="mr-2"></i> Cancel P.O</button>
              </form>
              {% endif %}

            </div>
          </div>
        </td>



      <td>{{ po.id }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

{% if page_obj.paginator.count > 0 %}
  <div class="dataTables_info text-muted mb-2" role="status" aria-live="polite">
    Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} entries
  </div>
{% endif %}

<nav aria-label="Purchase Order pagination">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page=1{% if request.GET.urlencode %}&{{ request.GET.urlencode|safe|cut:'page='|cut:'&page=' }}{% endif %}">&laquo; First</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode|safe|cut:'page='|cut:'&page=' }}{% endif %}">Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo; First</span></li>
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}

    <li class="page-item active">
      <span class="page-link">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </span>
    </li>

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode|safe|cut:'page='|cut:'&page=' }}{% endif %}">Next</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.urlencode %}&{{ request.GET.urlencode|safe|cut:'page='|cut:'&page=' }}{% endif %}">Last &raquo;</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
      <li class="page-item disabled"><span class="page-link">Last &raquo;</span></li>
    {% endif %}
  </ul>
</nav>



{% include "confirm_page.html" %}


<script src="{% static 'js/dashboard.js' %}"></script>



{% endblock %}
